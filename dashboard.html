 <!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GROWINN ‚Äî Dashboard</title>

  <!-- üîπ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤ CSS ‡¶ì HTML ‡¶è‡¶ï‡¶¶‡¶Æ ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
  <style>
    /* ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ Dashboard-4.html ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã style ‡¶Ö‡¶Ç‡¶∂ Í∑∏ÎåÄÎ°ú ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
  </style>
</head>

<body>
  <!-- üîπ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ Dashboard-4.html ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã body ‡¶ï‡¶®‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶•‡¶æ‡¶ï‡¶¨‡ßá (sidebar, content, ‡¶∏‡¶¨ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá) -->

  <!-- ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶æ‡¶á ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import {
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      where,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // üîπ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ö‡ßá‡¶ï
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const uid = user.uid;
      const userRef = doc(db, "users", uid);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        alert("User data not found!");
        return;
      }

      const data = snap.data();

      // Dashboard Data
      document.getElementById("balance")?.textContent = data.balance || "0";
      document.getElementById("totalInvest")?.textContent = data.totalInvest || "0";

      // Profile Data
      document.getElementById("user-name")?.textContent = data.name || "N/A";
      document.getElementById("user-email")?.textContent = user.email;
      document.getElementById("user-phone")?.textContent = data.phone || "N/A";
      document.getElementById("user-date")?.textContent = data.joinDate || "N/A";

      // Referral
      const refEl = document.getElementById("ref-code");
      if (refEl) {
        refEl.textContent = data.referralCode || uid;
      }

      // Investment Data
      const investRef = collection(db, "investments");
      const q = query(investRef, where("uid", "==", uid));
      const investSnap = await getDocs(q);

      let investHTML = "";
      investSnap.forEach((doc) => {
        const inv = doc.data();
        investHTML += `
          <tr>
            <td>${inv.planName}</td>
            <td>${inv.amount}</td>
            <td>${inv.rate}%</td>
            <td>${inv.date}</td>
          </tr>`;
      });
      document.getElementById("investments-table")?.insertAdjacentHTML("beforeend", investHTML || `<tr><td colspan="4">No investments yet</td></tr>`);

      // History (Deposit/Withdraw)
      const histRef = collection(db, "history");
      const hq = query(histRef, where("uid", "==", uid));
      const histSnap = await getDocs(hq);

      let histHTML = "";
      histSnap.forEach((doc) => {
        const h = doc.data();
        histHTML += `
          <tr>
            <td>${h.type}</td>
            <td>${h.amount}</td>
            <td>${h.date}</td>
          </tr>`;
      });
      document.getElementById("history-table")?.insertAdjacentHTML("beforeend", histHTML || `<tr><td colspan="3">No history yet</td></tr>`);

      // Investment Plans
      const plansRef = collection(db, "plans");
      const planSnap = await getDocs(plansRef);
      let plansHTML = "";
      planSnap.forEach((doc) => {
        const p = doc.data();
        plansHTML += `
          <div class="plan-box">
            <h4>${p.planName}</h4>
            <div class="plan-amount">Min: ${p.minAmount}</div>
            <div class="plan-rate">Rate: ${p.rate}% for ${p.duration} days</div>
          </div>`;
      });
      document.getElementById("plans-list")?.insertAdjacentHTML("beforeend", plansHTML || "<p>No plans yet</p>");

      // Withdraw Submit
      const withdrawBtn = document.getElementById("withdraw-btn");
      withdrawBtn?.addEventListener("click", async () => {
        const amount = document.getElementById("withdraw-amount").value;
        if (!amount) return alert("Enter amount");

        await addDoc(collection(db, "withdrawRequests"), {
          uid,
          amount,
          status: "Pending",
          date: new Date().toLocaleDateString(),
          time: serverTimestamp(),
        });
        alert("Withdraw request sent successfully!");
      });

      // Support Form
      const supportForm = document.getElementById("support-form");
      supportForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("support-msg").value;
        if (!msg) return alert("Please write a message");
        await addDoc(collection(db, "support"), {
          uid,
          message: msg,
          date: new Date().toLocaleString(),
        });
        alert("Support message sent!");
        supportForm.reset();
      });

      // Sidebar Navigation
      const navBtns = document.querySelectorAll(".nav-btn");
      const sections = document.querySelectorAll(".section");

      navBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.target;
          navBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          sections.forEach((sec) => {
            if (sec.id === target) sec.style.display = "block";
            else sec.style.display = "none";
          });
        });
      });

      // Loading Hide
      document.getElementById("loading")?.remove();
    });
  </script>

  <style>
    /* Dynamic Section Hide-Show Control */
    .section { display: none; }
    .section.active { display: block; }
  </style>
</body>
</html>
